---
title: "BestModel"
author: "Yenan Guan"
date: "4/1/2018"
output: html_document
---
## Import the latest flatfile
```{r message = FALSE, warning = FALSE}
rm(list = ls())
library(readr)
corn.data <- read_csv("~/Downloads/Flatfile_Corn_4.1.csv")
corn.data = data.frame(corn.data)
names(corn.data)
corn.data = corn.data[, !names(corn.data) %in% c("X1")]
```

## Categorize the variables
```{r}
corn_region = corn.data[,c("IL","IA","MI_KY_IN","MN_WI","MO_KS_CO","ND_SD","NE","OH_NorthEastern_sts","Unknown")]
corn_RFM_FYM1 = corn.data[, c("RECENCY_SCORE_FYM1", "FREQUENCY_SCORE_FYM1", "MONETARY_SCORE_FYM1")]
corn_AREA_FYM1 = corn.data[, c("MON_AREA_FYM1", "OPPO_CROP_AREA_FYM1")]
corn_KPI_FYM1 = corn.data[, c("RECENCY_SCORE_FYM1", "FREQUENCY_SCORE_FYM1", "MONETARY_SCORE_FYM1", "PURCH_PRBLTY_FYM1")]
```

## dat7
### Data frame: one lagged year sales quantity + region + area + KPI + lagged Monsanto area
```{r message = FALSE}
n = dim(corn.data)[1]
set.seed(1)
train = sample(n, 0.9*n)
attach(corn.data)
var = c("GRWR_ID", "GNSQ_FY", "BRND_DESC")
dat7 = cbind(corn.data[,var], 
             GNSQ_FYM1,
             GNSQ_FYM1_other,
             sumLagMON_AREA,
             corn_region,
             corn_AREA_FYM1,
             corn_KPI_FYM1)
```

### Sales Quantity Prediction - Linear Regression
```{r}
lm.fit=lm(GNSQ_FY~., data = dat7[train,-which(names(dat7) == "GRWR_ID")])
lm.pred = predict(lm.fit, newdata = dat7[-train,-which(names(dat7) == "GRWR_ID")])
summary(lm.fit)$r.squared # in-sample R2
mean(lm.fit$residuals^2) # in-sample MSE
```
* in-sample
    + MSE: 2731.524
    + R-Squared: 0.5816805

```{r}
dat7$lm_pred = 0
dat7[-train, "lm_pred"] = lm.pred
mean((dat7[-train, "lm_pred"] - dat7[-train, "GNSQ_FY"])^2) # out-sample MSE, non-aggr
SST = sum((dat7[-train, "GNSQ_FY"] - mean(dat7[train, "GNSQ_FY"]))^2)
SSE = sum((dat7[-train, "lm_pred"] - mean(dat7[-train, "GNSQ_FY"]))^2)
r.squared = SSE/SST # out-sample R2, non-aggr
r.squared 
```
* out-sample (non-aggregated)
+ MSE: 2652.492
+ R-Squared: 0.6043924

```{r}
dat.grower = dat7[-train, c("GRWR_ID", "GNSQ_FY", "lm_pred")]
dat.grower = aggregate(.~ GRWR_ID, dat.grower, sum)
mean((dat.grower$lm_pred - dat.grower$GNSQ_FY)^2) # out-sample MSE, aggr
SST = sum((dat.grower$GNSQ_FY - mean(dat.grower$GNSQ_FY))^2)
SSE = sum((dat.grower$lm_pred - mean(dat.grower$GNSQ_FY))^2)
r.squared = SSE/SST # out-sample R2, aggr
r.squared 
```
* out-sample (aggregated)
+ MSE: 2724.38
+ R-Squared: 0.6057023

### Churn Prediction - Logistics Regression
```{r}
var = c("GRWR_ID", "GNSQ_FY")
dat7$purchase = 1
dat7[dat7$GNSQ_FY == 0, "purchase"] = 0
glm.fit = glm(purchase ~., data = dat7[train, -which(names(dat7) == var)], family = binomial)
glm.pred = predict(glm.fit, dat7[-train, -which(names(dat7) == var)], type = "response")
dat7$glm_pred = 0
dat7[-train, "glm_pred"] = glm.pred
dat7$pur_pred = 0
dat7[dat7$glm_pred > 0.5, "pur_pred"] = 1
mean(dat7[-train, "pur_pred"] == dat7[-train, "purchase"]) 
```
* Threshold: 0.5 - Prediction accuracy: 0.8259721

#### Confusion Matrix
```{r message = FALSE}
library(caret)
library(e1071)
confusionMatrix(data = as.factor(dat7[-train, "pur_pred"]), reference = as.factor(dat7[-train, "purchase"]))
```
Confusion Matrix and Statistics
R: Reference
P: Prediction

  Confusion Matrix  |   Reference 0   |   Reference 1
------------------- | --------------- | --------------
  Prediction 0      | 18397           | 3073
  Prediction 1      | 2132            | 6307
                                          
               Accuracy : 0.826           
                 95% CI : (0.8216, 0.8303)
    No Information Rate : 0.6864          
    P-Value [Acc > NIR] : < 2.2e-16       
                                          
                  Kappa : 0.5845          
 Mcnemar's Test P-Value : < 2.2e-16       
                                          
            Sensitivity : 0.8961          
            Specificity : 0.6724          
         Pos Pred Value : 0.8569          
         Neg Pred Value : 0.7474          
             Prevalence : 0.6864          
         Detection Rate : 0.6151          
   Detection Prevalence : 0.7178          
      Balanced Accuracy : 0.7843          
                                          
       'Positive' Class : 0               
       
### Analysis through a typical grower
#### Take means of all numeric variables
```{r}
num_var = c("GNSQ_FYM1", "GNSQ_FYM1_other", "sumLagMON_AREA", "MON_AREA_FYM1", "OPPO_CROP_AREA_FYM1", "sumLagMON_AREA", "RECENCY_SCORE_FYM1", "FREQUENCY_SCORE_FYM1", "MONETARY_SCORE_FYM1", "PURCH_PRBLTY_FYM1")
X = colMeans(dat7[, which(names(dat7) %in% num_var)])
X = data.frame(X)
beta = data.frame(lm.fit$coefficients)
beta = data.frame(t(beta))
beta_num = data.frame(t(beta[, which(names(beta) %in% num_var)]))
df = cbind(beta_num, X)
avg_numeric = sum(df$lm.fit.coefficients * df$X)
```
#### add intercept
```{r}
intercept = as.numeric(beta[1])
```
#### brand 
```{r}
which.max(table(dat7$BRND_DESC))
brand_mode_coef = beta[, grepl(".*DEKALB", names(beta))]
```
DEKALB
#### region
```{r}
which.max(colSums(corn_region))
region_mode_coef = beta[, grepl("MN_WI", names(beta))]
```
MN_WI
#### average of numeric variables + intercept + mode brand coefficient + mode region coefficient
```{r}
avg = intercept + avg_numeric + brand_mode_coef + region_mode_coef
avg
```
28.05405

